{% extends 'layout.html' %}

{% load static %}

{% block title %}
	ToolBoard: {{ self.title }}
{% endblock %}

{% block extra_css %}
	{{ block.super }}
	<!-- FULLCALENDAR: Calendar and scheduler -->
	<link rel="stylesheet" href="{% static 'plugins/fullcalendar/custom_calendar.css' %}"/>
  	<link rel="stylesheet" href="{% static 'plugins/fullcalendar/fullcalendar.min.css' %}"/>
  	<link rel="stylesheet" href="{% static 'plugins/fullcalendar/scheduler.min.css' %}"/> 
{% endblock %}

{% block content %}

   <div class="row">
      	<div class="col-sm-12 content">
<!-- General info -->
        	<div class="dashhead">
          		<div class="dashhead-titles">
            		<h1 class="dashhead-title">{{ page.name }}</h1>
            		<h4 class="dashhead-subtitle">Toolboard</h4>
          		</div>
          		<div class="btn-group m-l-lg m-t-xs">
		            <button type="button" class="btn btn-primary-outline dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
		              	<span class="icon icon-pencil"></span> 
		              	New 
		              	<span class="caret"></span>
		            </button>
		            <ul class="dropdown-menu" role="menu">
			            <li>
			            	<a href="#" data-toggle="modal" data-target="#taskmodal" data-tool="{{page.pk}}">Task</a>
			            </li>
			            <li>
			            	<a href="#">Event</a>
			            </li>
		            </ul>
          		</div>
        	</div>
		    <hr class="m-y-xs">
	        <div class="pull-right">
	        	<h2 class="m-t-0">
	        		<a data-toggle="collapse" data-target="#collapse-info" class="collapsor"></a>
	        	</h2>
		    </div>
		    <div class="row collapse in" id="collapse-info">
		      	<div class="col-md-6 col-md-offset-6">
		        	<div class="row">
		          		<div class="col-xs-4">
		          			<h4>
		          				<span class="icon icon-flow-tree"></span> {{ page.name }} Modules
		          			</h4>
					        <ul id="module-list">
					        	{% for module in page.submodules %}
					        	<li>{{ module }}</li>
					        	{% endfor %}
					        </ul>      	
		          		</div>
				        <div class="col-xs-4">
				            <h4>
				            	<span class="icon icon-tools"></span> Hardware
				            </h4>
				            <ul>
				            	{% for person in page.hw_responsibles.all %}
				            	<li>{{ person|capfirst }}</li>
				            	{% endfor %}
				            </ul>
				        </div>
				        <div class="col-xs-4">
				            <h4>
				            	<span class="icon icon-gauge"></span> Process
				            </h4>
				            <ul>
				            	{% for person in page.process_responsibles.all %}
				            	<li>{{ person|capfirst }}</li>
				            	{% endfor %}
				            </ul>
				        </div>
		        	</div>
		      	</div>
		    </div>
<!-- Timeline -->
	        <div class="dashhead m-t">
	          	<div class="dashhead-titles">
		    		<h2 class="dashhead-title">Timeline
		    			<a data-toggle="collapse" data-target="#collapse-timeline" class="collapsor">
		    			</a>
		    		</h2>
	          	</div>
	        </div>
	        <hr class="m-t-0 m-b-sm">
	        {% if page.activities %}
		        <div class="row collapse in p-b-md" id="collapse-timeline">
		        	<div class="col-xs-12">
		        		<div id="calendar"></div>
		        	</div>
		        </div>
	        {% else %}
		        <div class="row collapse in p-b-md" id="collapse-timeline">
		        	<div class="col-xs-12">
		        		<p>No tasks available ... </p>
		        	</div>
		        </div>
	        {% endif %}
<!-- Action list -->
		    <div class="dashhead m-t">
		      	<div class="dashhead-titles">
		    		<h2 class="dashhead-title">Tasks & Events
		    			<a data-toggle="collapse" data-target="#collapse-time" class="collapsor">
		    			</a>
		    		</h2>
		      	</div>
		      	<a data-toggle="popover" data-placement="left" title="Color Legend" data-content="<i>hier komt de inhoud</i>" data-trigger="click" data-html="true" class="info-link pull-right">
		      		<i class="fa fa-info-circle"></i>
		      	</a>
          		<div class="btn-group m-l-lg">
		            <button type="button" class="btn btn-sm btn-primary-outline dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
		              	<span class="icon icon-pencil"></span> 
		              	Add 
		              	<span class="caret"></span>
		            </button>
		            <ul class="dropdown-menu" role="menu">
			            <li>
			            	<a href="#" data-toggle="modal" data-target="#taskmodal" data-tool="{{page.pk}}">Task</a>
			            </li>
			            <li>
			            	<a href="#">Event</a>
			            </li>
		            </ul>
          		</div>
		    </div>
		    <hr class="m-y-xs">
		    <div class="row collapse in" id="collapse-time">
		      	<div class="col-md-4 p-a-0">
		        	<h3 class="text-center">To Do / Upcoming</h3>
		        	<div id="upcoming" class="p-a-xs m-a-xs equal-height" style="background-color: #434857;">
		        		{% for item in page.todo_tasks_events %}
		        			{% include 'tool/partials/task_event_alert.html' with item=item %}
		        		{% endfor %}
		    		</div>
		      	</div>
		    	<div class="col-md-4 p-a-0">
		        	<h3 class="text-center">In Progress</h3>
		    		<div id="progress" class="p-a-xs m-a-xs equal-height" style="background-color: #434857;">
		    		    {% for task in page.loose_tasks %}
						<div class="alert alert-success m-a-xs" role="alert">
						    <h4 class="m-a-xs">{{ task }} <a data-toggle="modal" data-target="#taskmodal" data-taskid="{{ task.id }}" class="info"><i class="fa fa-info-circle"></i></a></h4>
		          			<hr>
						</div>		    	
		        		{% endfor %}
					</div>
		    	</div>
		    	<div class="col-md-4 p-a-0">
		        	<h3 class="text-center">Done</h3>
		        	<div id="done" class="p-a-xs m-a-xs equal-height" style="min-height:100px; background-color: #434857;">

		    		</div>
		    	</div>
		    </div>
<!-- Requests -->
		    <div class="dashhead m-t">
			    <div class="dashhead-titles">
			    	<h2 class="dashhead-title">Requests
			    		<a data-toggle="collapse" data-target="#collapse-request" class="collapsor">
			    		</a>
			    	</h2>
			    </div>
				<a data-toggle="popover" data-placement="left" title="Color Legend" data-content="<i>hier komt de inhoud</i>" data-trigger="click" data-html="true" class="info-link pull-right">
					<i class="fa fa-info-circle"></i>
				</a>
	            <button type="button" class="btn btn-sm btn-primary-outline m-l-lg" data-toggle="modal" data-target="#requestmodal">
	              	<span class="icon icon-pencil"></span> 
	              	Add 
	            </button>
		    </div>
		    <hr class="m-y-xs">
		    <div class="row collapse in" id="collapse-request">
		      	<div class="col-md-3 p-a-0">
		        	<h3 class="text-center">Requested</h3>
		        	<div id="requested" class="p-a-xs m-a-xs equal-height" style="background-color: #434857;">
	        		{% for request in page.requested_requests %}
	        			{% include 'request/partials/request_alert.html' with request=request %}
	        		{% endfor %}
		    		</div>
		      	</div>
		      	<div class="col-md-3 p-a-0">
		        	<h3 class="text-center">Rejected</h3>
		        	<div id="rejected" class="p-a-xs m-a-xs equal-height" style="background-color: #434857;">
	        		{% for request in page.rejected_requests %}
	        			{% include 'request/partials/request_alert.html' with request=request %}
	        		{% endfor %}
		    		</div>
		      	</div>
		      	<div class="col-md-3 p-a-0">
		        	<h3 class="text-center">Accepted</h3>
		        	<div id="accepted" class="p-a-xs m-a-xs equal-height" style="background-color: #434857;">
	        		{% for request in page.accepted_requests %}
	        			{% include 'request/partials/request_alert.html' with request=request %}
	        		{% endfor %}
		    		</div>
		      	</div>
		      	<div class="col-md-3 p-a-0">
		        	<h3 class="text-center">Planned</h3>
		        	<div id="planned" class="p-a-xs m-a-xs equal-height" style="background-color: #434857;">
	        		{% for request in page.planned_requests %}
	        			{% include 'request/partials/request_alert.html' with request=request %}
	        		{% endfor %}
		    		</div>
		      	</div>
		    </div>
	  	</div>
    </div>

{% endblock content %}

{% block modals %}
	<div id="taskmodal" class="modal fade">
  	</div>
  	<div id="requestmodal" class="modal fade">
  	</div>
{% endblock %}

{% block extra_js %}
    {# Override this in templates to add extra javascript #}
        {{ block.super }}

		<!-- MOMENT: Datetime representations-->
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment.min.js"></script>
		<!-- FULLCALENDAR: Calendar and scheduler -->
		<script type="text/javascript" src="{% static 'plugins/fullcalendar/fullcalendar.min.js' %}"></script>
	  	<script type="text/javascript" src="{% static 'plugins/fullcalendar/scheduler.min.js' %}"></script>
	  	<!-- MATCHHEIGHT: Init-->
	  	<script type="text/javascript">
		  	$(function() {
		  		$.fn.matchHeight._maintainScroll = true;
		    	$('.equal-height').matchHeight();
		  	});
	  	</script>
	  	<!-- FULLCALENDAR: Init-->
		<script>
	   		$(function() { // dom ready
		      $('#calendar').fullCalendar({
		        schedulerLicenseKey: 'GPL-My-Project-Is-Open-Source',
		        resourceAreaWidth: 140,
		        defaultDate: '2016-08-08',
		        defaultDate: moment().startOf('day'),	// Today in Moment.js
		        editable: true,
		        //aspectRatio: 4.35,
		        contentHeight: 30 * {{ page.task_count_distinct_owner }} + 28,  /* aantal resources bepaalt hoogte van kalender */
		        eventOverlap: false,
		        //scrollTime: '00:00',
		        minTime: '05:00',
		        maxTime: '23:00',
		        header: {
		          left: 'promptResource today prev,next',
		          //left: null,
		          center: 'title',
		          //right: 'timelineDay,timelineThreeDays,timelineTenDays,month',
		          //right: null 
		          right: 'timelineDay,timelineWW,timeline2WW'
		        },
		        customButtons: {
		        },
		        defaultView: 'timelineDay',
		        views: {
		          timelineDay: {
		            buttonText: 'Today',
		            slotDuration: '01:00',
		            duration: {days: 7 }
		          },
		          timelineWW: {
		            type: 'timeline',
		            slotDuration: '04:00',
		            duration: { days: 7 }
		          },
		          timeline2WW: {
		            type: 'timeline',
		            slotDuration: '08:00',
		            duration: { days: 14 }
		          }
		        },
		        resourceLabelText: 'Owner',
		        resources: '/api/resources/tool/{{ page.pk }}/',
		        events: '/api/events/tool/{{ page.pk }}/', /* events list afkomstig van url */
		        //eventClick: function(event) {
		        	/* This callback gets executed when an event is being clicked by a user */

		          //$('#calendartaskmodal').modal();
		 
		       // },
		        eventAfterRender: function(event, element, view) {
		        	/* This callback get executed when an event is added to the calendar */

		        	// Add Bootstrap modal data attributes
		        	$(element).attr('data-taskid', event.id);
		        	$(element).attr('data-target', '#calendartaskmodal');
		        	$(element).attr('data-toggle', 'modal');
		        }
		      });
		    });
	  	</script>
    	<script type="text/javascript">
		    options = {
		      revertOnSpill: true,
		      // invalid option to disallow tool events from being dragged
		      invalid: function(el, handle) {
		      	if ($(el).hasClass('tool-event')) {
		      		return true;
		      	}

	      		return false;
		      }
		    }
		  	// initieer Dragula 
		  	drake = dragula([upcoming, progress, done], options);
		  	// Use jQuery matchHeight om kolommen van dezelfde hoogte te verzekeren na elk drop event
		  	drake.on('drop', function(el, target, source, sibling) {
		  		$('.equal-height').matchHeight();
		  		console.log('drop');
		  	});
		  	drake.on('dragend', function(el, target, source, sibling) {
		  		console.log('drag end');
		  	});

	  	</script>
    	<script type="text/javascript">
		    options = {
		      revertOnSpill: true
		    }
		  	// initieer Dragula 
		  	drake = dragula([requested, rejected, accepted, planned], options);
		  	// Use jQuery matchHeight om kolommen van dezelfde hoogte te verzekeren na elk drop event
		  	drake.on('drop', function(el, target, source, sibling) {
		  		$('.equal-height').matchHeight();
		  		console.log('drop');
		  	});
		  	drake.on('dragend', function(el, target, source, sibling) {
		  		console.log('drag end');
		  	});

	  	</script>
		<script type="text/javascript">
			$(function() {
				$.fn.matchHeight._maintainScroll = true;
			    $('.equal-height').matchHeight();
			});
		</script>
		<script type="text/javascript">
			$('#taskmodal').on('show.bs.modal', function(e){

				var id = $(e.relatedTarget).data("tool")

				console.log('tool: ' + id)

				$.ajax({
					url:"/tasks/new/tool/" + id,
					type: "GET",

					success: task_handler,

					error: function(xhr, ajaxOptions, thrownError) {
						console.log(xhr.status);
						alert(thrownError);
					}
				});

				function task_handler(data) {
					$('#taskmodal').html(data);
				};
			})
		</script>
		<script type="text/javascript">
			$('#requestmodal').on('show.bs.modal', function(e){

				var id = $(e.relatedTarget).data("tool")

				console.log('tool: ' + id)

				$.ajax({
					url:"/requests/new/tool/" + {{ page.pk }},
					type: "GET",

					success: task_handler,

					error: function(xhr, ajaxOptions, thrownError) {
						console.log(xhr.status);
						alert(thrownError);
					}
				});

				function task_handler(data) {
					$('#requestmodal').html(data);
				};
			})
		</script>
		<script type="text/javascript">
			$(function (){
				$('[data-toggle="popover"]').popover()
			});
		</script>
{% endblock %}
